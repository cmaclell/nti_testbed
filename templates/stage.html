<div id="wholeLevel">
    <div id="gameContainer" class="hasOutline"></div>
    <div id="sidePanel" class="hasOutline">
        <h4>Interaction Log</h4>
        <div id="serverMessages" class="hasOutline">
        </div>
        <div id="chatmessageDiv">
        </div>
        <h4>Training Actions</h4>
        <div id="holdButtons" class="hasOutline">
        </div>
    </div>
</div>

<script src="Build/UnityLoader.js"></script>
<script>
    var gameInstance = UnityLoader.instantiate("gameContainer", "Build/build 36 7-19-18 yellow buttons and trying to log less.json");
    // this is build 36 with html interface 11
</script>

<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

<script type="text/javascript" charset="utf-8">
    console.log("ws://" + window.location.host);
    var socket = io.connect("ws://" + window.location.host); //'ws://localhost:5000');

    //var trainer;
    var id;
    var buttonIdCounter = 0;

    //document.getElementById('testDisplay1').innerHTML = "changed as a test for javascript";
    socket.on('connect', function() {
        //socket.emit('message', {data: 'I\'m connected!'});
        //document.getElementById('testDisplay1').innerHTML = "changed as a test for socket connect";
        //socket.emit('htmlMessage', "egg salad 4");



        var currentUrlString = window.location.href;
        console.log(currentUrlString);
        //http://localhost:5000/exp?hitId=debugV0M43W&assignmentId=debugEXVKP1&workerId=debug8GBALW&mode=debug
        var indexOfStartOfWorkerId = currentUrlString.indexOf("workerId");
        var indexOfAmpersandAtEndOfWorkerId = currentUrlString.indexOf("&", indexOfStartOfWorkerId);

        var workerIdString = currentUrlString.substring(indexOfStartOfWorkerId + 9, indexOfAmpersandAtEndOfWorkerId);

        var indexOfStartOfAssignmentId = currentUrlString.indexOf("assignmentId");
        var indexOfAmpersandAtEndOfAssignmentId = currentUrlString.indexOf("&", indexOfStartOfAssignmentId);

        var assignmentIdString = currentUrlString.substring(indexOfStartOfAssignmentId + 13, indexOfAmpersandAtEndOfAssignmentId);

        var finalIdString = workerIdString + ":" + assignmentIdString

        console.log(finalIdString);

        socket.emit('join', {
            'id': finalIdString
        });

        id = finalIdString;
    });
    /*socket.on('initializeInterface', function(data) {
      console.log(data);
            actor = data.actor;
            id = data.id;
            document.getElementById('actorTitle').innerHTML = actor.charAt(0).toUpperCase() + actor.slice(1) + " Interface:";
    });*/

    function requestButtons() {

        socket.emit("requestTestTrainingButtons");
    }

    function clearServerOutput() {

        socket.emit("clearAll");
    }

    function requestLock() {

        socket.emit("requestLock");
    }

    function requestUnlock() {

        socket.emit("requestUnlock");
    }

    function requestLockChatBox() {

        socket.emit("requestLockChatBox");
    }

    function requestUnlockChatBox() {

        socket.emit("requestUnlockChatBox");
    }

    function requestResetUnity() {

        socket.emit("requestResetUnity");
    }

    function requestUnityAction() {
        socket.emit("requestActionBroadcast");
    }

    /*socket.on('getTrainingButton', function(data) {
      //e.g. data = {"identifier"="890",buttonText="Request Feedback"}
            document.getElementById('holdButtons').innerHTML += '<div class="recievedButtonContainer"><button class="recievedButton" onclick="socket.emit(\'onTrainingButtonPress\',{\'identifier\':\'' + data.identifier + '\',\'id\':\'' + id + '\',\'actor\':\'' + actor + '\'})">' + data.buttonText + "</button></div>"
            
    });*/

    socket.on('getTrainingButtons', function(buttonList) {
        document.getElementById('holdButtons').innerHTML = "";
        for (var i = 0; i < buttonList.length; i++) {

            //e.g. data = {"identifier"="890",buttonText="Request Feedback"}

            var data = buttonList[i];

            //document.getElementById('holdButtons').innerHTML += '<div class="recievedButtonContainer"><button class="recievedButton" onclick="socket.emit(\'onTrainingButtonPress\',{\'identifier\':\'' + data.identifier + '\',\'id\':\'' + id + '\',\'actor\':\'' + actor + '\'})">' + data.buttonText + "</button></div>"

            document.getElementById('holdButtons').innerHTML += '<button class="receivedButton" onclick="socket.emit(\'onTrainingButtonPress\',{\'identifier\':\'' + data.identifier + '\',\'id\':\'' + id + '\'})">' + data.buttonText + "</button>";

            $('#holdButtons').effect('highlight', {}, 1500);
        }



    });
    socket.on('sendTrainingMessage', function(message) {
        console.log(message);
        // document.getElementById('serverMessages').innerHTML += "<p>" + message + "</p>";

        var m = $('<p></p>').text(message);

        $('#serverMessages').append(m);
        $("#serverMessages").scrollTop($("#serverMessages")[0].scrollHeight);
        $(m).effect("highlight", {}, 1500);
    });

    socket.on('instructions', function(message) {
        console.log("instructions: " + message);
    });

    socket.on('clearTrainingMessages', function(message) {
        document.getElementById('serverMessages').innerHTML = "<p> The Log: </p>";

    });

    //OBSOLETE FUNCTION: clearTrainingButtons
    socket.on('clearTrainingButtons', function(message) {
        document.getElementById('holdButtons').innerHTML = "";

    });


    socket.on('lockButtons', function() {
        var buttonList = document.getElementsByClassName("receivedButton");
        for (var i = 0; i < buttonList.length; i++) {
            buttonList[i].setAttribute('disabled', 'disabled')
        }

    });
    socket.on('unlockButtons', function() {
        var buttonList = document.getElementsByClassName("receivedButton");
        for (var i = 0; i < buttonList.length; i++) {
            buttonList[i].removeAttribute("disabled");
        }


    });

    socket.on('lockChatBox', lockChatBox);
    socket.on('unlockChatBox', unlockChatBox);

    function unlockChatBox() {
        document.getElementById('chatmessageDiv').innerHTML = `<input type="text" id="chatBox"> <button id="chatMessageButton" onclick="sendChatMessage()">Send</button>`
        document.getElementById("chatmessageDiv").classList.add('hasOutline');
        document.getElementById("chatmessageDiv").style.paddingBottom = "0.5px";
        $('#chatBox').keypress(function(e){
            if (e.which == 13) {
                sendChatMessage();
            }
        });
    }

    function lockChatBox() {
        document.getElementById('chatmessageDiv').innerHTML = ""
        document.getElementById("chatmessageDiv").classList.remove('hasOutline');
        document.getElementById("chatmessageDiv").style.paddingBottom = "0";
    }

    function sendChatMessage() {
        socket.emit("getChatMessage", {
            'message':
                // document.getElementById('chatBox').value,'actor': actor,'id': id});
                document.getElementById('chatBox').value,
            'id': id
        });
        document.getElementById('chatBox').value = "";
    }
</script>
