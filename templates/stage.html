<div id="wholeLevel">
    <div id="gameContainer" class="hasOutline"></div>
    <div id="sidePanel" class="hasOutline">
        <h4>Interaction Log</h4>
        <div id="serverMessages" class="hasOutline">
        </div>
        <div id="chatmessageDiv" class="hasOutline">
            <input type="text" id="chatBox" autocomplete="off"/>
            <button id="chatMessageButton">Send</button>
        </div>
        <h4>Training Actions</h4>
        <div id="holdButtons" class="hasOutline">
        </div>
    </div>
</div>

<script src="Build/UnityLoader.js"></script>
<script>
    var gameInstance = UnityLoader.instantiate("gameContainer", 
        "Build/build 36 7-19-18 yellow buttons and trying to log less.json");
    // this is build 36 with html interface 11
</script>

<script type="text/javascript" charset="utf-8">
    var socket = io.connect("ws://" + window.location.host); 

    //var trainer;
    var id;
    var buttonIdCounter = 0;

    socket.on('connect', function() {
        var currentUrlString = window.location.href;
        var indexOfStartOfWorkerId = currentUrlString.indexOf("workerId");
        var indexOfAmpersandAtEndOfWorkerId = currentUrlString.indexOf("&", indexOfStartOfWorkerId);
        var workerIdString = currentUrlString.substring(indexOfStartOfWorkerId + 9, indexOfAmpersandAtEndOfWorkerId);
        var indexOfStartOfAssignmentId = currentUrlString.indexOf("assignmentId");
        var indexOfAmpersandAtEndOfAssignmentId = currentUrlString.indexOf("&", indexOfStartOfAssignmentId);
        var assignmentIdString = currentUrlString.substring(indexOfStartOfAssignmentId + 13, indexOfAmpersandAtEndOfAssignmentId);
        var finalIdString = workerIdString + ":" + assignmentIdString

        socket.emit('join', {
            'id': finalIdString
        });

        id = finalIdString;

    });

    socket.on('getTrainingButtons', function(buttonList) {
        $('#holdButtons').html("");
        for (var i = 0; i < buttonList.length; i++) {
            var data = buttonList[i];
            var button = $("<button>" + data.buttonText + "</button>");
            $(button).addClass('receivedButton');

            $(button).on('click', function(){
                socket.emit('onTrainingButtonPress', {
                    'identifier': '' + data.identifier,
                    'id': '' + id
                });
            });

            $('#holdButtons').append(button);
            $('#holdButtons').effect('highlight', {}, 1500);
        }
    });

    socket.on('sendTrainingMessage', function(message) {
        var m = $('<p></p>').text(message);
        $('#serverMessages').append(m);
        $("#serverMessages").scrollTop($("#serverMessages")[0].scrollHeight);
        $(m).effect("highlight", {}, 1500);
    });

    socket.on('instructions', function(message) {
        console.log("instructions: " + message);
    });

    socket.on('clearTrainingMessages', function(message) {
        $('#serverMessages').html("");
    });

    //OBSOLETE FUNCTION: clearTrainingButtons
    socket.on('clearTrainingButtons', function(message) {
        $('#holdButtons').html('');
    });

    socket.on('lockButtons', lockButtons);
    socket.on('unlockButtons', unlockButtons);
    socket.on('lockChatBox', lockChatBox);
    socket.on('unlockChatBox', unlockChatBox);

    function lockButtons() {
        $('.receivedButton').attr('disabled', 'disabled');
    }

    function unlockButtons() {
        $('.receivedButton').removeAttr('disabled');
    }

    function unlockChatBox() {
        $('#chatmessageDiv').show();
    }

    function lockChatBox() {
        $('#chatmessageDiv').hide();
    }

    function sendChatMessage() {
        socket.emit("getChatMessage", {
            'message':
                document.getElementById('chatBox').value,
            'id': id
        });
        document.getElementById('chatBox').value = "";
    }

    function requestButtons() {
        socket.emit("requestTestTrainingButtons");
    }

    function clearServerOutput() {
        socket.emit("clearAll");
    }

    function requestLock() {
        socket.emit("requestLock");
    }

    function requestUnlock() {
        socket.emit("requestUnlock");
    }

    function requestLockChatBox() {
        socket.emit("requestLockChatBox");
    }

    function requestUnlockChatBox() {
        socket.emit("requestUnlockChatBox");
    }

    function requestResetUnity() {
        socket.emit("requestResetUnity");
    }

    function requestUnityAction() {
        socket.emit("requestActionBroadcast");
    }

    $(function(){
        $('#chatMessageButton').on('click', sendChatMessage);
        $('#chatBox').keypress(function(e){
            if (e.which == 13) {
                sendChatMessage();
            }
        });
        lockChatBox();
    });

</script>
